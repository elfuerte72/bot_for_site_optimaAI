#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Heroku

set -e

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Heroku"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ -z "$1" ]; then
    echo -e "${RED}‚ùå –£–∫–∞–∂–∏—Ç–µ –∏–º—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Heroku${NC}"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./setup-heroku-env.sh <app-name> [env-file]"
    exit 1
fi

APP_NAME=$1
ENV_FILE=${2:-.env}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}‚ùå –§–∞–π–ª $ENV_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π"
    exit 1
fi

echo -e "${YELLOW}üì± –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: $APP_NAME${NC}"
echo -e "${YELLOW}üìÑ –§–∞–π–ª –æ–∫—Ä—É–∂–µ–Ω–∏—è: $ENV_FILE${NC}"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
read_secure_value() {
    local var_name=$1
    local prompt=$2
    echo -n "$prompt: "
    read -s value
    echo
    echo "$value"
}

# –ß—Ç–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
echo -e "\n${GREEN}üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è...${NC}\n"

while IFS='=' read -r key value; do
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    if [[ -z "$key" || "$key" =~ ^[[:space:]]*# ]]; then
        continue
    fi
    
    # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã
    key=$(echo "$key" | xargs)
    value=$(echo "$value" | xargs)
    
    # –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    value="${value%\"}"
    value="${value#\"}"
    value="${value%\'}"
    value="${value#\'}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    if [[ "$key" == "OPENAI_API_KEY" && "$value" == "sk-"* ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  $key –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ placeholder${NC}"
        value=$(read_secure_value "$key" "–í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π OpenAI API –∫–ª—é—á")
    elif [[ "$key" == "API_KEY" && ${#value} -lt 20 ]]; then
        echo -e "${YELLOW}‚ö†Ô∏è  $key —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏${NC}"
        value=$(read_secure_value "$key" "–í–≤–µ–¥–∏—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π API –∫–ª—é—á (–º–∏–Ω–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤)")
    fi
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    echo -n "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é $key... "
    if heroku config:set "$key=$value" -a "$APP_NAME" >/dev/null 2>&1; then
        echo -e "${GREEN}‚úÖ${NC}"
    else
        echo -e "${RED}‚ùå${NC}"
        echo -e "${RED}–û—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ $key${NC}"
    fi
done < "$ENV_FILE"

echo -e "\n${GREEN}üìã –¢–µ–∫—É—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:${NC}"
heroku config -a "$APP_NAME"

echo -e "\n${GREEN}‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${NC}"
echo -e "${YELLOW}üí° –°–æ–≤–µ—Ç: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'heroku config:unset VAR_NAME -a $APP_NAME' –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π${NC}"