2025-06-01 10:40:59,745 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 10:40:59,746 - api - INFO - Request: GET /health from testclient
2025-06-01 10:40:59,747 - api - INFO - Response: GET /health completed in 0.002s with status 200
2025-06-01 10:40:59,748 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:41:08,333 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 10:41:08,334 - api - INFO - Request: GET /health from testclient
2025-06-01 10:41:08,336 - api - INFO - Response: GET /health completed in 0.002s with status 200
2025-06-01 10:41:08,337 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:41:08,339 - api - INFO - Request: GET /metrics from testclient
2025-06-01 10:41:08,340 - api - INFO - Response: GET /metrics completed in 0.001s with status 200
2025-06-01 10:41:08,341 - httpx - INFO - HTTP Request: GET http://testserver/metrics "HTTP/1.1 200 OK"
2025-06-01 10:41:08,342 - api - INFO - Request: GET /security/status from testclient
2025-06-01 10:41:08,342 - src.middleware.auth - WARNING - Отсутствует API ключ для /security/status
2025-06-01 10:41:08,343 - api - ERROR - Error: GET /security/status failed after 0.000s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:41:08,343 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:41:08,501 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:41:08,502 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 10:41:08,502 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:41:08,502 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:41:08,637 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:41:08,638 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 10:41:08,638 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:41:08,638 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:42:24,388 - api - INFO - Request: GET /health from testclient
2025-06-01 10:42:24,389 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:42:24,390 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:42:34,675 - api - INFO - Request: GET /health from testclient
2025-06-01 10:42:34,676 - api - INFO - Response: GET /health completed in 0.000s with status 200
2025-06-01 10:42:34,676 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:42:34,678 - api - INFO - Request: GET /metrics from testclient
2025-06-01 10:42:34,678 - api - INFO - Response: GET /metrics completed in 0.000s with status 200
2025-06-01 10:42:34,679 - httpx - INFO - HTTP Request: GET http://testserver/metrics "HTTP/1.1 200 OK"
2025-06-01 10:42:34,681 - api - INFO - Request: GET /security/status from testclient
2025-06-01 10:42:34,681 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 10:42:34,681 - api - INFO - Response: GET /security/status completed in 0.001s with status 200
2025-06-01 10:42:34,681 - httpx - INFO - HTTP Request: GET http://testserver/security/status "HTTP/1.1 200 OK"
2025-06-01 10:42:34,684 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:42:34,685 - api - INFO - Response: POST /chat completed in 0.002s with status 422
2025-06-01 10:42:34,686 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 422 Unprocessable Entity"
2025-06-01 10:42:34,730 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:42:34,731 - main - ERROR - Ошибка при генерации ответа: object MagicMock can't be used in 'await' expression
2025-06-01 10:42:34,731 - main - ERROR - Ошибка приложения: Не удалось сгенерировать ответ: object MagicMock can't be used in 'await' expression
2025-06-01 10:42:34,731 - api - INFO - Response: POST /chat completed in 0.001s with status 400
2025-06-01 10:42:34,732 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 400 Bad Request"
2025-06-01 10:44:25,156 - api - INFO - Request: GET /health from testclient
2025-06-01 10:44:25,157 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:44:25,158 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:44:25,160 - api - INFO - Request: GET /metrics from testclient
2025-06-01 10:44:25,160 - api - INFO - Response: GET /metrics completed in 0.000s with status 200
2025-06-01 10:44:25,160 - httpx - INFO - HTTP Request: GET http://testserver/metrics "HTTP/1.1 200 OK"
2025-06-01 10:44:25,162 - api - INFO - Request: GET /security/status from testclient
2025-06-01 10:44:25,163 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 10:44:25,163 - api - INFO - Response: GET /security/status completed in 0.001s with status 200
2025-06-01 10:44:25,163 - httpx - INFO - HTTP Request: GET http://testserver/security/status "HTTP/1.1 200 OK"
2025-06-01 10:44:25,165 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:44:25,166 - api - INFO - Response: POST /chat completed in 0.001s with status 422
2025-06-01 10:44:25,166 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 422 Unprocessable Entity"
2025-06-01 10:44:25,169 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:44:25,170 - api - INFO - Response: POST /chat completed in 0.001s with status 200
2025-06-01 10:44:25,170 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 200 OK"
2025-06-01 10:45:41,682 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:45:41,684 - api - INFO - Response: POST /chat completed in 0.002s with status 200
2025-06-01 10:45:41,684 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 200 OK"
2025-06-01 10:47:04,113 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:47:04,115 - api - INFO - Response: POST /chat completed in 0.002s with status 200
2025-06-01 10:47:04,116 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 200 OK"
2025-06-01 10:47:28,316 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:47:28,317 - api - INFO - Response: POST /chat completed in 0.002s with status 200
2025-06-01 10:47:28,318 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 200 OK"
2025-06-01 10:51:22,823 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:51:22,825 - api - INFO - Response: POST /chat completed in 0.002s with status 200
2025-06-01 10:51:22,826 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 200 OK"
2025-06-01 10:51:54,118 - api - INFO - Request: GET /health from testclient
2025-06-01 10:51:54,119 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:51:54,120 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:51:54,122 - api - INFO - Request: GET /metrics from testclient
2025-06-01 10:51:54,123 - api - INFO - Response: GET /metrics completed in 0.000s with status 200
2025-06-01 10:51:54,123 - httpx - INFO - HTTP Request: GET http://testserver/metrics "HTTP/1.1 200 OK"
2025-06-01 10:51:54,126 - api - INFO - Request: GET /security/status from testclient
2025-06-01 10:51:54,127 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 10:51:54,127 - api - INFO - Response: GET /security/status completed in 0.001s with status 200
2025-06-01 10:51:54,127 - httpx - INFO - HTTP Request: GET http://testserver/security/status "HTTP/1.1 200 OK"
2025-06-01 10:51:54,129 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:51:54,131 - api - INFO - Response: POST /chat completed in 0.001s with status 422
2025-06-01 10:51:54,131 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 422 Unprocessable Entity"
2025-06-01 10:51:54,134 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:51:54,135 - api - INFO - Response: POST /chat completed in 0.001s with status 200
2025-06-01 10:51:54,135 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 200 OK"
2025-06-01 10:52:03,471 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 10:52:03,472 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:03,474 - api - INFO - Response: GET /health completed in 0.002s with status 200
2025-06-01 10:52:03,476 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:03,478 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:52:03,479 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 10:52:03,479 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:03,480 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:03,826 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:52:03,827 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 10:52:03,827 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:03,827 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:04,124 - api - INFO - Request: GET /cache/stats from testclient
2025-06-01 10:52:04,124 - src.middleware.auth - WARNING - Отсутствует API ключ для /cache/stats
2025-06-01 10:52:04,125 - api - ERROR - Error: GET /cache/stats failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:04,125 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:04,388 - api - INFO - Request: GET /metrics from testclient
2025-06-01 10:52:04,389 - api - INFO - Response: GET /metrics completed in 0.001s with status 200
2025-06-01 10:52:04,390 - httpx - INFO - HTTP Request: GET http://testserver/metrics "HTTP/1.1 200 OK"
2025-06-01 10:52:04,392 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:04,394 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:04,395 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:04,401 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:04,402 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:04,403 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:04,405 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:52:04,406 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 10:52:04,406 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:04,406 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:04,678 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:04,679 - api - INFO - Response: GET /health completed in 0.000s with status 200
2025-06-01 10:52:04,679 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:04,683 - api - INFO - Request: GET /metrics from testclient
2025-06-01 10:52:04,683 - api - INFO - Response: GET /metrics completed in 0.000s with status 200
2025-06-01 10:52:04,684 - httpx - INFO - HTTP Request: GET http://testserver/metrics "HTTP/1.1 200 OK"
2025-06-01 10:52:04,687 - api - INFO - Request: GET /security/status from testclient
2025-06-01 10:52:04,688 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 10:52:04,688 - api - INFO - Response: GET /security/status completed in 0.001s with status 200
2025-06-01 10:52:04,689 - httpx - INFO - HTTP Request: GET http://testserver/security/status "HTTP/1.1 200 OK"
2025-06-01 10:52:04,692 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:52:04,694 - api - INFO - Response: POST /chat completed in 0.002s with status 422
2025-06-01 10:52:04,695 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 422 Unprocessable Entity"
2025-06-01 10:52:04,699 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:52:04,700 - api - INFO - Response: POST /chat completed in 0.001s with status 200
2025-06-01 10:52:04,701 - httpx - INFO - HTTP Request: POST http://testserver/chat "HTTP/1.1 200 OK"
2025-06-01 10:52:04,704 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:04,706 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:04,707 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:04,709 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:04,710 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:04,711 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:04,713 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:04,714 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:04,715 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:04,787 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:52:04,788 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 10:52:04,788 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:04,788 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:05,061 - api - INFO - Request: OPTIONS /health from testclient
2025-06-01 10:52:05,062 - api - INFO - Response: OPTIONS /health completed in 0.001s with status 405
2025-06-01 10:52:05,063 - httpx - INFO - HTTP Request: OPTIONS http://testserver/health "HTTP/1.1 405 Method Not Allowed"
2025-06-01 10:52:05,071 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,072 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,073 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,075 - api - INFO - Request: GET /security/status from testclient
2025-06-01 10:52:05,075 - src.middleware.auth - WARNING - Отсутствует API ключ для /security/status
2025-06-01 10:52:05,075 - api - ERROR - Error: GET /security/status failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:05,076 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:52:05,345 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,346 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,347 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,348 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,349 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,350 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,351 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,352 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,353 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,354 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,355 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,356 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,356 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,357 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,359 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,359 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,360 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,361 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,362 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,363 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,364 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,364 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,365 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,366 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,367 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,368 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,369 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:52:05,370 - api - INFO - Request: GET /health from testclient
2025-06-01 10:52:05,371 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 10:52:05,372 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 10:53:01,526 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 10:53:01,527 - api - INFO - Request: POST /chat from testclient
2025-06-01 10:53:01,527 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 10:53:01,528 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 10:53:01,528 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 11:27:41,350 - src.validators.input_validator - WARNING - Использование '*' для CORS небезопасно в продакшене
2025-06-01 11:27:41,351 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: [;&|`$(){}[\]\\]
2025-06-01 11:27:41,351 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: [;&|`$(){}[\]\\]
2025-06-01 11:27:41,351 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: [;&|`$(){}[\]\\]
2025-06-01 11:27:41,352 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: javascript:
2025-06-01 11:27:41,352 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: [;&|`$(){}[\]\\]
2025-06-01 11:27:41,352 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: \b(union|select|insert|update|delete|drop|create|alter)\b
2025-06-01 11:27:41,352 - src.validators.input_validator - WARNING - Обнаружен подозрительный контент: \b(ignore|forget|disregard)\s+(previous|above|system|instructions?)\b
2025-06-01 11:27:41,352 - src.validators.input_validator - WARNING - Обнаружен подозрительный контент: \b(act\s+as|pretend\s+to\s+be|roleplay)\b
2025-06-01 11:27:41,352 - src.validators.input_validator - WARNING - Обнаружен подозрительный контент: \b(system\s+prompt|internal\s+instructions?)\b
2025-06-01 11:27:41,352 - src.validators.input_validator - WARNING - Обнаружен подозрительный контент: \b(rm\s+-rf|del\s+/|format\s+c:)\b
2025-06-01 11:27:41,353 - src.validators.input_validator - WARNING - Обнаружен подозрительный контент: \b(ignore|forget|disregard)\s+(previous|above|system|instructions?)\b
2025-06-01 11:27:41,353 - src.validators.input_validator - WARNING - Ошибка валидации запроса: Ошибки валидации: messages: Value error, Небезопасное сообщение: Сообщение содержит недопустимый контент; temperature: Input should be less than or equal to 2; max_tokens: Input should be less than or equal to 4000
2025-06-01 11:27:41,353 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 11:27:41,359 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 11:27:41,359 - api - INFO - Request: GET /health from testclient
2025-06-01 11:27:41,360 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 11:27:41,361 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 11:27:41,363 - api - INFO - Request: POST /chat from testclient
2025-06-01 11:27:41,364 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 11:27:41,364 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 11:27:41,364 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 11:27:41,522 - api - INFO - Request: POST /chat from testclient
2025-06-01 11:27:41,522 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 11:27:41,522 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 11:27:41,522 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 11:27:41,628 - api - INFO - Request: GET /cache/stats from testclient
2025-06-01 11:27:41,629 - src.middleware.auth - WARNING - Отсутствует API ключ для /cache/stats
2025-06-01 11:27:41,629 - api - ERROR - Error: GET /cache/stats failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 11:27:41,629 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 11:27:41,735 - api - INFO - Request: GET /metrics from testclient
2025-06-01 11:27:41,736 - api - INFO - Response: GET /metrics completed in 0.001s with status 200
2025-06-01 11:27:41,736 - httpx - INFO - HTTP Request: GET http://testserver/metrics "HTTP/1.1 200 OK"
2025-06-01 11:27:41,737 - api - INFO - Request: GET /health from testclient
2025-06-01 11:27:41,738 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 11:27:41,738 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 11:27:41,741 - api - INFO - Request: GET /health from testclient
2025-06-01 11:27:41,742 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-01 11:27:41,742 - httpx - INFO - HTTP Request: GET http://testserver/health "HTTP/1.1 200 OK"
2025-06-01 11:27:41,743 - api - INFO - Request: POST /chat from testclient
2025-06-01 11:27:41,743 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 11:27:41,744 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 11:27:41,744 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:24:16,222 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:24:16,279 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 12:24:16,279 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 12:24:16,279 - main - INFO - Кэш-сервис инициализирован
2025-06-01 12:24:16,279 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:24:16,279 - main - INFO - Приложение успешно запущено
2025-06-01 12:25:26,187 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-01 12:25:26,190 - api - INFO - Response: GET /health completed in 0.003s with status 200
2025-06-01 12:25:50,466 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:25:50,467 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 12:25:50,467 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:25:50,467 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:25:50,480 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:25:50,481 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 12:25:50,481 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:25:50,481 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:25:50,491 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:25:50,491 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 12:25:50,491 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:25:50,491 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:25:50,500 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:25:50,501 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 12:25:50,501 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:25:50,501 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:25:50,511 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:25:50,511 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 12:25:50,512 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:25:50,512 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 12:27:05,077 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:27:05,078 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:27:05,109 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:27:05,227 - faiss.loader - INFO - Loading faiss.
2025-06-01 12:27:05,251 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-01 12:27:05,257 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-01 12:27:05,265 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:27:05,265 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:27:06,502 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:27:07,514 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 404 Not Found"
2025-06-01 12:27:07,517 - src.services.rag_service - ERROR - Ошибка при получении ответа из RAG системы: Error code: 404 - {'error': {'message': 'The model `gpt-4o-nano` does not exist or you do not have access to it.', 'type': 'invalid_request_error', 'param': None, 'code': 'model_not_found'}}
2025-06-01 12:27:07,518 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 247 символов
2025-06-01 12:27:07,523 - api - INFO - Response: POST /chat completed in 2.446s with status 200
2025-06-01 12:27:07,528 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:27:07,529 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:27:07,546 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:27:07,578 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:27:07,579 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:27:08,380 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:27:09,572 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 404 Not Found"
2025-06-01 12:27:09,573 - src.services.rag_service - ERROR - Ошибка при получении ответа из RAG системы: Error code: 404 - {'error': {'message': 'The model `gpt-4o-nano` does not exist or you do not have access to it.', 'type': 'invalid_request_error', 'param': None, 'code': 'model_not_found'}}
2025-06-01 12:27:09,573 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 247 символов
2025-06-01 12:27:09,578 - api - INFO - Response: POST /chat completed in 2.049s with status 200
2025-06-01 12:27:09,582 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:27:09,583 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:27:09,599 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:27:09,630 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:27:09,630 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:27:10,336 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:27:11,405 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 404 Not Found"
2025-06-01 12:27:11,406 - src.services.rag_service - ERROR - Ошибка при получении ответа из RAG системы: Error code: 404 - {'error': {'message': 'The model `gpt-4o-nano` does not exist or you do not have access to it.', 'type': 'invalid_request_error', 'param': None, 'code': 'model_not_found'}}
2025-06-01 12:27:11,406 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 247 символов
2025-06-01 12:27:11,412 - api - INFO - Response: POST /chat completed in 1.830s with status 200
2025-06-01 12:27:11,416 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:27:11,417 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:27:11,433 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:27:11,463 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:27:11,463 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:27:12,077 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:27:13,301 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 404 Not Found"
2025-06-01 12:27:13,303 - src.services.rag_service - ERROR - Ошибка при получении ответа из RAG системы: Error code: 404 - {'error': {'message': 'The model `gpt-4o-nano` does not exist or you do not have access to it.', 'type': 'invalid_request_error', 'param': None, 'code': 'model_not_found'}}
2025-06-01 12:27:13,303 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 247 символов
2025-06-01 12:27:13,308 - api - INFO - Response: POST /chat completed in 1.891s with status 200
2025-06-01 12:28:07,987 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:28:08,012 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 12:28:08,013 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 12:28:08,013 - main - INFO - Кэш-сервис инициализирован
2025-06-01 12:28:08,013 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:28:08,013 - main - INFO - Приложение успешно запущено
2025-06-01 12:28:08,013 - main - INFO - Завершение работы приложения
2025-06-01 12:28:08,014 - main - INFO - Кэш очищен
2025-06-01 12:28:20,380 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-01 12:28:20,384 - api - INFO - Response: GET /health completed in 0.004s with status 200
2025-06-01 12:28:28,333 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:28:28,334 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:28:28,346 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:28:28,368 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:28:28,368 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:28:29,578 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:28:31,140 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 404 Not Found"
2025-06-01 12:28:31,142 - src.services.rag_service - ERROR - Ошибка при получении ответа из RAG системы: Error code: 404 - {'error': {'message': 'The model `gpt-4o-nano` does not exist or you do not have access to it.', 'type': 'invalid_request_error', 'param': None, 'code': 'model_not_found'}}
2025-06-01 12:28:31,142 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 247 символов
2025-06-01 12:28:31,147 - api - INFO - Response: POST /chat completed in 2.814s with status 200
2025-06-01 12:28:31,153 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:28:31,155 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:28:31,170 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:28:31,207 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:28:31,208 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:28:32,023 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:28:32,852 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 404 Not Found"
2025-06-01 12:28:32,855 - src.services.rag_service - ERROR - Ошибка при получении ответа из RAG системы: Error code: 404 - {'error': {'message': 'The model `gpt-4o-nano` does not exist or you do not have access to it.', 'type': 'invalid_request_error', 'param': None, 'code': 'model_not_found'}}
2025-06-01 12:28:32,855 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 247 символов
2025-06-01 12:28:32,865 - api - INFO - Response: POST /chat completed in 1.713s with status 200
2025-06-01 12:28:32,870 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:28:32,872 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:28:32,887 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:28:32,918 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:28:32,918 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:28:33,827 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:28:37,112 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 404 Not Found"
2025-06-01 12:28:37,113 - src.services.rag_service - ERROR - Ошибка при получении ответа из RAG системы: Error code: 404 - {'error': {'message': 'The model `gpt-4o-nano` does not exist or you do not have access to it.', 'type': 'invalid_request_error', 'param': None, 'code': 'model_not_found'}}
2025-06-01 12:28:37,113 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 247 символов
2025-06-01 12:28:37,116 - api - INFO - Response: POST /chat completed in 4.246s with status 200
2025-06-01 12:28:37,121 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:28:37,122 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:28:37,137 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:28:37,167 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:28:37,167 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:28:38,117 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:28:39,430 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 404 Not Found"
2025-06-01 12:28:39,430 - src.services.rag_service - ERROR - Ошибка при получении ответа из RAG системы: Error code: 404 - {'error': {'message': 'The model `gpt-4o-nano` does not exist or you do not have access to it.', 'type': 'invalid_request_error', 'param': None, 'code': 'model_not_found'}}
2025-06-01 12:28:39,431 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 247 символов
2025-06-01 12:28:39,434 - api - INFO - Response: POST /chat completed in 2.313s with status 200
2025-06-01 12:28:39,438 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:28:39,439 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:28:39,454 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:28:39,485 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:28:39,485 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:28:40,631 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:28:41,873 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 404 Not Found"
2025-06-01 12:28:41,874 - src.services.rag_service - ERROR - Ошибка при получении ответа из RAG системы: Error code: 404 - {'error': {'message': 'The model `gpt-4o-nano` does not exist or you do not have access to it.', 'type': 'invalid_request_error', 'param': None, 'code': 'model_not_found'}}
2025-06-01 12:28:41,874 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 247 символов
2025-06-01 12:28:41,881 - api - INFO - Response: POST /chat completed in 2.443s with status 200
2025-06-01 12:28:56,037 - main - INFO - Завершение работы приложения
2025-06-01 12:28:56,037 - main - INFO - Кэш очищен
2025-06-01 12:28:59,989 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:29:00,012 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 12:29:00,012 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 12:29:00,013 - main - INFO - Кэш-сервис инициализирован
2025-06-01 12:29:00,013 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:29:00,013 - main - INFO - Приложение успешно запущено
2025-06-01 12:29:09,616 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:29:09,616 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:29:09,644 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:29:09,760 - faiss.loader - INFO - Loading faiss.
2025-06-01 12:29:09,772 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-01 12:29:09,777 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-01 12:29:09,784 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:29:09,784 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:29:10,639 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:29:15,206 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 12:29:15,216 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 1094 символов
2025-06-01 12:29:15,221 - api - INFO - Response: POST /chat completed in 5.605s with status 200
2025-06-01 12:29:15,226 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:29:15,227 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:29:15,242 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:29:15,271 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:29:15,272 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:29:15,922 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:29:20,122 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 12:29:20,124 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 501 символов
2025-06-01 12:29:20,128 - api - INFO - Response: POST /chat completed in 4.902s with status 200
2025-06-01 12:29:20,132 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:29:20,133 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:29:20,149 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:29:20,181 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:29:20,181 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:29:21,049 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:29:23,156 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 12:29:23,158 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 96 символов
2025-06-01 12:29:23,162 - api - INFO - Response: POST /chat completed in 3.030s with status 200
2025-06-01 12:29:23,167 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:29:23,167 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:29:23,185 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:29:23,216 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:29:23,216 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:29:23,969 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:29:25,650 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 12:29:25,652 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 155 символов
2025-06-01 12:29:25,655 - api - INFO - Response: POST /chat completed in 2.488s with status 200
2025-06-01 12:29:25,658 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 12:29:25,659 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 12:29:25,673 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 12:29:25,706 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 12:29:25,706 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 12:29:26,513 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 12:29:30,361 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 12:29:30,362 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 732 символов
2025-06-01 12:29:30,371 - api - INFO - Response: POST /chat completed in 4.713s with status 200
2025-06-01 12:50:04,155 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:50:04,187 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 12:50:04,188 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 12:50:04,188 - main - INFO - Кэш-сервис инициализирован
2025-06-01 12:50:04,188 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:50:04,188 - main - INFO - Приложение успешно запущено
2025-06-01 12:50:04,190 - main - INFO - Завершение работы приложения
2025-06-01 12:50:04,190 - main - INFO - Кэш очищен
2025-06-01 12:50:38,191 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:50:38,214 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 12:50:38,214 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 12:50:38,214 - main - INFO - Кэш-сервис инициализирован
2025-06-01 12:50:38,215 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:50:38,215 - main - INFO - Приложение успешно запущено
2025-06-01 12:50:38,215 - main - INFO - Завершение работы приложения
2025-06-01 12:50:38,215 - main - INFO - Кэш очищен
2025-06-01 12:51:53,391 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:51:53,417 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 12:51:53,418 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 12:51:53,418 - main - INFO - Кэш-сервис инициализирован
2025-06-01 12:51:53,418 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 12:51:53,418 - main - INFO - Приложение успешно запущено
2025-06-01 12:51:53,418 - main - INFO - Завершение работы приложения
2025-06-01 12:51:53,418 - main - INFO - Кэш очищен
2025-06-01 13:03:01,242 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 13:03:01,273 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 13:03:01,274 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 13:03:01,274 - main - INFO - Кэш-сервис инициализирован
2025-06-01 13:03:01,274 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 13:03:01,274 - main - INFO - Приложение успешно запущено
2025-06-01 13:04:28,047 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:04:28,049 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 13:04:28,050 - api - ERROR - Error: POST /chat failed after 0.003s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:04:28,050 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:04:57,052 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:04:57,053 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 13:04:57,054 - api - ERROR - Error: POST /chat failed after 0.002s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:04:57,054 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:05:30,817 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-01 13:05:30,823 - api - INFO - Response: GET /health completed in 0.006s with status 200
2025-06-01 13:05:44,171 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:05:44,172 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:05:44,176 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 13:05:44,213 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:05:44,362 - faiss.loader - INFO - Loading faiss.
2025-06-01 13:05:44,400 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-01 13:05:44,405 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-01 13:05:44,413 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:05:44,413 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:05:46,158 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:05:50,061 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:05:50,068 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 528 символов
2025-06-01 13:05:50,068 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 13:05:50,072 - api - INFO - Response: POST /chat completed in 5.900s with status 200
2025-06-01 13:07:33,255 - api - INFO - Request: GET /docs from 127.0.0.1
2025-06-01 13:07:33,257 - api - INFO - Response: GET /docs completed in 0.003s with status 200
2025-06-01 13:07:39,589 - api - INFO - Request: GET /openapi.json from 127.0.0.1
2025-06-01 13:07:39,605 - api - INFO - Response: GET /openapi.json completed in 0.016s with status 200
2025-06-01 13:08:19,960 - main - INFO - Завершение работы приложения
2025-06-01 13:08:19,960 - main - INFO - Кэш очищен
2025-06-01 13:08:31,172 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 13:08:31,208 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 13:08:31,209 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 13:08:31,209 - main - INFO - Кэш-сервис инициализирован
2025-06-01 13:08:31,209 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 13:08:31,209 - main - INFO - Приложение успешно запущено
2025-06-01 13:08:38,088 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-01 13:08:38,093 - api - INFO - Response: GET /health completed in 0.004s with status 200
2025-06-01 13:08:47,805 - api - INFO - Request: POST /api/chat from 127.0.0.1
2025-06-01 13:08:47,806 - src.middleware.auth - INFO - Успешная аутентификация для /api/chat
2025-06-01 13:08:47,808 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 13:08:47,836 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:08:47,955 - faiss.loader - INFO - Loading faiss.
2025-06-01 13:08:47,982 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-01 13:08:47,985 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-01 13:08:47,993 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:08:47,993 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:08:49,702 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:08:51,124 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:08:51,129 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 63 символов
2025-06-01 13:08:51,129 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 13:08:51,132 - api - INFO - Response: POST /api/chat completed in 3.327s with status 200
2025-06-01 13:08:58,804 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:08:58,805 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:08:58,806 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 13:08:58,814 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:08:58,834 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:08:58,834 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:08:59,957 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:09:01,962 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:09:01,965 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 257 символов
2025-06-01 13:09:01,966 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 13:09:01,971 - api - INFO - Response: POST /chat completed in 3.167s with status 200
2025-06-01 13:09:19,256 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:09:19,258 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 13:09:19,259 - api - ERROR - Error: POST /chat failed after 0.004s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:09:19,259 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:09:41,732 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:09:41,733 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 13:09:41,734 - api - ERROR - Error: POST /chat failed after 0.002s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:09:41,734 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:22:53,397 - main - INFO - Завершение работы приложения
2025-06-01 13:22:53,398 - main - INFO - Кэш очищен
2025-06-01 13:22:56,801 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 13:22:56,832 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 13:22:56,832 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 13:22:56,832 - main - INFO - Кэш-сервис инициализирован
2025-06-01 13:22:56,832 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 13:22:56,832 - main - INFO - Приложение успешно запущено
2025-06-01 13:33:21,387 - api - INFO - Request: POST /api/chat from 127.0.0.1
2025-06-01 13:33:21,389 - src.middleware.auth - WARNING - Неверный API ключ для /api/chat
2025-06-01 13:33:21,390 - api - ERROR - Error: POST /api/chat failed after 0.003s: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:33:21,390 - main - ERROR - Неожиданная ошибка: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    |     raise HTTPException(
    |     ...<7 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    raise HTTPException(
    ...<7 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:33:49,617 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 13:33:49,647 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 13:33:49,648 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 13:33:49,648 - main - INFO - Кэш-сервис инициализирован
2025-06-01 13:33:49,648 - src.security.config_validator - INFO - ✅ Оценка безопасности: 95/100 (ОТЛИЧНО). Предупреждений: 1.
2025-06-01 13:33:49,648 - main - INFO - Приложение успешно запущено
2025-06-01 13:34:07,952 - api - INFO - Request: POST /api/chat from 127.0.0.1
2025-06-01 13:34:07,953 - src.middleware.auth - WARNING - Неверный API ключ для /api/chat
2025-06-01 13:34:07,954 - api - ERROR - Error: POST /api/chat failed after 0.002s: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:34:07,954 - main - ERROR - Неожиданная ошибка: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    |     raise HTTPException(
    |     ...<7 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    raise HTTPException(
    ...<7 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:34:28,159 - api - INFO - Request: POST /api/chat from 127.0.0.1
2025-06-01 13:34:28,161 - src.middleware.auth - WARNING - Неверный API ключ для /api/chat
2025-06-01 13:34:28,161 - api - ERROR - Error: POST /api/chat failed after 0.002s: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:34:28,162 - main - ERROR - Неожиданная ошибка: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    |     raise HTTPException(
    |     ...<7 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    raise HTTPException(
    ...<7 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:34:55,351 - api - INFO - Request: POST /api/chat from 127.0.0.1
2025-06-01 13:34:55,354 - src.middleware.auth - WARNING - Неверный API ключ для /api/chat
2025-06-01 13:34:55,355 - api - ERROR - Error: POST /api/chat failed after 0.004s: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:34:55,355 - main - ERROR - Неожиданная ошибка: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    |     raise HTTPException(
    |     ...<7 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    raise HTTPException(
    ...<7 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:34:55,410 - api - INFO - Request: POST /api/chat from 127.0.0.1
2025-06-01 13:34:55,410 - src.middleware.auth - WARNING - Неверный API ключ для /api/chat
2025-06-01 13:34:55,411 - api - ERROR - Error: POST /api/chat failed after 0.001s: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:34:55,411 - main - ERROR - Неожиданная ошибка: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    |     raise HTTPException(
    |     ...<7 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    raise HTTPException(
    ...<7 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:36:14,241 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-01 13:36:14,253 - api - INFO - Response: GET /health completed in 0.013s with status 200
2025-06-01 13:36:14,294 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:36:14,295 - src.middleware.auth - WARNING - Отсутствует API ключ для /chat
2025-06-01 13:36:14,295 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:36:14,296 - main - ERROR - Неожиданная ошибка: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    |     raise HTTPException(
    |     ...<9 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 108, in dispatch
    raise HTTPException(
    ...<9 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'API ключ обязателен', 'error_code': 'MISSING_API_KEY', 'details': {'required_header': 'Authorization: Bearer <api_key> или X-API-Key: <api_key>'}}
2025-06-01 13:36:14,326 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:36:14,327 - src.middleware.auth - WARNING - Неверный API ключ для /chat
2025-06-01 13:36:14,327 - api - ERROR - Error: POST /chat failed after 0.001s: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:36:14,328 - main - ERROR - Неожиданная ошибка: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
  + Exception Group Traceback (most recent call last):
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 76, in collapse_excgroups
  |     yield
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 178, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ~~~~~~~~~~~~~~~~~~~~~~~^^
  |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  |         "unhandled errors in a TaskGroup", self._exceptions
  |     ) from None
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    |     response = await call_next(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    |     raise app_exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    |     await self.app(scope, receive_or_disconnect, send_no_error)
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    |     with recv_stream, send_stream, collapse_excgroups():
    |                                    ~~~~~~~~~~~~~~~~~~^^
    |   File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    |     self.gen.throw(value)
    |     ~~~~~~~~~~~~~~^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    |     raise exc
    |   File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    |     raise HTTPException(
    |     ...<7 lines>...
    |     )
    | fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
    +------------------------------------

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 165, in __call__
    await self.app(scope, receive, _send)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/logging.py", line 50, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/sanitization.py", line 251, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/rate_limit.py", line 156, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 154, in call_next
    raise app_exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 141, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 177, in __call__
    with recv_stream, send_stream, collapse_excgroups():
                                   ~~~~~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.3/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 162, in __exit__
    self.gen.throw(value)
    ~~~~~~~~~~~~~~^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/_utils.py", line 82, in collapse_excgroups
    raise exc
  File "/Users/maximpenkin/Documents/openai/site/backend/.venv/lib/python3.13/site-packages/starlette/middleware/base.py", line 179, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/maximpenkin/Documents/openai/site/backend/src/middleware/auth.py", line 123, in dispatch
    raise HTTPException(
    ...<7 lines>...
    )
fastapi.exceptions.HTTPException: 401: {'error': 'Неверный API ключ', 'error_code': 'INVALID_API_KEY', 'details': {'message': 'Предоставленный API ключ недействителен'}}
2025-06-01 13:38:38,743 - main - INFO - Завершение работы приложения
2025-06-01 13:38:38,745 - main - INFO - Кэш очищен
2025-06-01 13:46:54,794 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-01 13:46:54,822 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 13:46:54,823 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 13:46:54,823 - main - INFO - Кэш-сервис инициализирован
2025-06-01 13:46:54,823 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-01 13:46:54,823 - main - INFO - Приложение успешно запущено
2025-06-01 13:47:32,099 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:47:32,100 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:47:32,102 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 13:47:32,132 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:47:32,280 - faiss.loader - INFO - Loading faiss.
2025-06-01 13:47:32,303 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-01 13:47:32,306 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-01 13:47:32,314 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:47:32,314 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:47:33,987 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:47:41,155 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:47:41,165 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 1035 символов
2025-06-01 13:47:41,165 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 13:47:41,170 - api - INFO - Response: POST /chat completed in 9.070s with status 200
2025-06-01 13:47:51,672 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:47:51,673 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: [;&|`$(){}[\]\\]
2025-06-01 13:47:51,674 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:47:51,676 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 13:47:51,688 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:47:51,715 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:47:51,715 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:47:52,621 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:47:55,765 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:47:55,766 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 509 символов
2025-06-01 13:47:55,767 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 13:47:55,770 - api - INFO - Response: POST /chat completed in 4.098s with status 200
2025-06-01 13:48:51,255 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:48:51,259 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: [;&|`$(){}[\]\\]
2025-06-01 13:48:51,260 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:48:51,262 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 13:48:51,275 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:48:51,295 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:48:51,295 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:48:52,840 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:48:54,965 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:48:54,967 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 313 символов
2025-06-01 13:48:54,968 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 13:48:54,972 - api - INFO - Response: POST /chat completed in 3.718s with status 200
2025-06-01 13:55:06,390 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-01 13:55:06,421 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 13:55:06,422 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 13:55:06,422 - main - INFO - Кэш-сервис инициализирован
2025-06-01 13:55:06,422 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-01 13:55:06,422 - main - INFO - Приложение успешно запущено
2025-06-01 13:55:06,423 - main - INFO - Завершение работы приложения
2025-06-01 13:55:06,423 - main - INFO - Кэш очищен
2025-06-01 13:55:17,637 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-01 13:55:17,642 - api - INFO - Response: GET /health completed in 0.005s with status 200
2025-06-01 13:55:25,482 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:55:25,483 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:55:25,492 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:55:25,516 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:55:25,516 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:55:27,081 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:55:32,359 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:55:32,362 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 560 символов
2025-06-01 13:55:32,366 - api - INFO - Response: POST /chat completed in 6.884s with status 200
2025-06-01 13:55:34,381 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:55:34,383 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:55:34,401 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:55:34,441 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:55:34,441 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:55:35,683 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:55:42,017 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:55:42,020 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 831 символов
2025-06-01 13:55:42,029 - api - INFO - Response: POST /chat completed in 7.648s with status 200
2025-06-01 13:55:44,039 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:55:44,041 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:55:44,060 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:55:44,095 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:55:44,095 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:55:44,897 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:55:48,177 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:55:48,180 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 444 символов
2025-06-01 13:55:48,184 - api - INFO - Response: POST /chat completed in 4.145s with status 200
2025-06-01 13:55:50,192 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:55:50,194 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: [;&|`$(){}[\]\\]
2025-06-01 13:55:50,195 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:55:50,215 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:55:50,248 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:55:50,248 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:55:51,298 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:55:57,123 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:55:57,125 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 648 символов
2025-06-01 13:55:57,128 - api - INFO - Response: POST /chat completed in 6.937s with status 200
2025-06-01 13:57:41,945 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 13:57:41,947 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 13:57:41,950 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 13:57:41,965 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 13:57:41,994 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 13:57:41,994 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 13:57:43,482 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 13:57:50,175 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 13:57:50,179 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 1107 символов
2025-06-01 13:57:50,179 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 13:57:50,190 - api - INFO - Response: POST /chat completed in 8.245s with status 200
2025-06-01 13:57:59,994 - main - INFO - Завершение работы приложения
2025-06-01 13:57:59,995 - main - INFO - Кэш очищен
2025-06-01 14:08:19,121 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-01 14:08:19,154 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-01 14:08:19,155 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-01 14:08:19,155 - main - INFO - Кэш-сервис инициализирован
2025-06-01 14:08:19,155 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-01 14:08:19,155 - main - INFO - Приложение успешно запущено
2025-06-01 14:08:46,220 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 14:08:46,221 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 14:08:46,224 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-01 14:08:46,225 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 14:08:46,255 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 14:08:46,377 - faiss.loader - INFO - Loading faiss.
2025-06-01 14:08:46,403 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-01 14:08:46,406 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-01 14:08:46,413 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 14:08:46,413 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 14:08:47,996 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 14:08:49,872 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 14:08:49,881 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 153 символов
2025-06-01 14:08:49,882 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 14:08:49,886 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-01 14:08:49,888 - api - INFO - Response: POST /chat completed in 3.669s with status 200
2025-06-01 14:08:49,890 - api - INFO - Response: GET /health completed in 0.004s with status 200
2025-06-01 14:08:49,899 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 14:08:49,900 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 14:08:49,901 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-01 14:08:49,914 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 14:08:49,941 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 14:08:49,941 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 14:08:50,648 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 14:08:52,129 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 14:08:52,132 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 36 символов
2025-06-01 14:08:52,137 - api - INFO - Response: POST /chat completed in 2.238s with status 200
2025-06-01 14:08:52,475 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-01 14:08:52,478 - api - INFO - Response: GET /health completed in 0.003s with status 200
2025-06-01 14:08:52,498 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 14:08:52,498 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 14:08:52,499 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-01 14:08:52,506 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 14:08:52,524 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 14:08:52,524 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 14:08:53,253 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 14:08:56,426 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 14:08:56,428 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 550 символов
2025-06-01 14:08:56,433 - api - INFO - Response: POST /chat completed in 3.935s with status 200
2025-06-01 14:09:02,840 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 14:09:02,842 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 14:09:02,843 - main - INFO - История сообщений обрезана: 3 сообщений
2025-06-01 14:09:02,843 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 14:09:02,854 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 14:09:02,881 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 14:09:02,881 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 14:09:04,003 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 14:09:07,587 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 14:09:07,589 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 498 символов
2025-06-01 14:09:07,590 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 14:09:07,594 - api - INFO - Response: POST /chat completed in 4.754s with status 200
2025-06-01 14:09:15,441 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 14:09:15,443 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: [;&|`$(){}[\]\\]
2025-06-01 14:09:15,443 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 14:09:15,444 - main - INFO - История сообщений обрезана: 5 сообщений
2025-06-01 14:09:15,444 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 14:09:15,458 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 14:09:15,490 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 14:09:15,490 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 14:09:16,391 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 14:09:19,875 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 14:09:19,877 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 563 символов
2025-06-01 14:09:19,877 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 14:09:19,885 - api - INFO - Response: POST /chat completed in 4.444s with status 200
2025-06-01 14:09:24,494 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-01 14:09:24,496 - src.middleware.sanitization - WARNING - Обнаружен потенциально опасный контент: [;&|`$(){}[\]\\]
2025-06-01 14:09:24,496 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-01 14:09:24,498 - main - INFO - История сообщений обрезана: 7 сообщений
2025-06-01 14:09:24,498 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-01 14:09:24,511 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-01 14:09:24,540 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-01 14:09:24,540 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-01 14:09:25,500 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-01 14:10:37,261 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-01 14:10:37,601 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 567 символов
2025-06-01 14:10:37,602 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-01 14:10:37,612 - api - INFO - Request: HEAD /docs from 127.0.0.1
2025-06-01 14:10:37,614 - api - INFO - Response: POST /chat completed in 73.120s with status 200
2025-06-01 14:10:37,615 - api - INFO - Response: HEAD /docs completed in 0.003s with status 200
2025-06-08 12:11:23,834 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-08 12:11:23,948 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-08 12:11:23,948 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-08 12:11:23,948 - main - INFO - Кэш-сервис инициализирован
2025-06-08 12:11:23,948 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-08 12:11:23,948 - main - INFO - Приложение успешно запущено
2025-06-08 12:11:52,578 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-08 12:11:52,581 - api - INFO - Response: GET /health completed in 0.004s with status 200
2025-06-08 12:11:52,586 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:11:52,586 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:11:52,592 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:11:52,627 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:11:52,814 - faiss.loader - INFO - Loading faiss.
2025-06-08 12:11:52,986 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-08 12:11:52,990 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-08 12:11:53,002 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:11:53,002 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:11:56,744 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:12:00,121 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:12:00,133 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 360 символов
2025-06-08 12:12:00,138 - api - INFO - Response: POST /chat completed in 7.552s with status 200
2025-06-08 12:12:01,452 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-08 12:12:01,453 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-08 12:12:01,549 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:12:01,549 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:12:01,550 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:12:01,556 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:12:01,573 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:12:01,573 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:12:03,338 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:12:09,338 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:12:09,342 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 618 символов
2025-06-08 12:12:09,348 - api - INFO - Response: POST /chat completed in 7.799s with status 200
2025-06-08 12:12:47,774 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:12:47,777 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:12:47,780 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:12:47,780 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-08 12:12:47,790 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:12:47,819 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:12:47,819 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:12:49,282 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:12:56,542 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:12:56,546 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 981 символов
2025-06-08 12:12:56,546 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-08 12:12:56,550 - api - INFO - Response: POST /chat completed in 8.777s with status 200
2025-06-08 12:13:28,757 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:13:28,764 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:13:28,767 - main - INFO - История сообщений обрезана: 3 сообщений
2025-06-08 12:13:28,767 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-08 12:13:28,779 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:13:28,803 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:13:28,803 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:13:29,595 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:13:33,201 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:13:33,205 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 661 символов
2025-06-08 12:13:33,206 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-08 12:13:33,209 - api - INFO - Response: POST /chat completed in 4.452s with status 200
2025-06-08 12:14:11,306 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:14:11,309 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:14:11,312 - main - INFO - История сообщений обрезана: 5 сообщений
2025-06-08 12:14:11,312 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-08 12:14:11,323 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:14:11,352 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:14:11,352 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:14:12,641 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:14:16,544 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:14:16,546 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 457 символов
2025-06-08 12:14:16,546 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-08 12:14:16,554 - api - INFO - Response: POST /chat completed in 5.248s with status 200
2025-06-08 12:14:59,501 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:14:59,504 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:14:59,506 - main - INFO - История сообщений обрезана: 7 сообщений
2025-06-08 12:14:59,506 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-08 12:14:59,519 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:14:59,542 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:14:59,542 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:15:00,409 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:15:04,133 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:15:04,136 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 707 символов
2025-06-08 12:15:04,137 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-08 12:15:04,142 - api - INFO - Response: POST /chat completed in 4.641s with status 200
2025-06-08 12:17:38,299 - main - INFO - Завершение работы приложения
2025-06-08 12:17:38,300 - main - INFO - Кэш очищен
2025-06-08 12:17:43,293 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-08 12:17:43,317 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-08 12:17:43,317 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-08 12:17:43,317 - main - INFO - Кэш-сервис инициализирован
2025-06-08 12:17:43,317 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-08 12:17:43,317 - main - INFO - Приложение успешно запущено
2025-06-08 12:18:12,451 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-08 12:18:12,454 - api - INFO - Response: GET /health completed in 0.003s with status 200
2025-06-08 12:18:12,458 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:18:12,459 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:18:12,462 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:18:12,489 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:18:12,605 - faiss.loader - INFO - Loading faiss.
2025-06-08 12:18:12,630 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-08 12:18:12,634 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-08 12:18:12,642 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:18:12,642 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:18:13,360 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:18:16,133 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:18:16,143 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 346 символов
2025-06-08 12:18:16,148 - api - INFO - Response: POST /chat completed in 3.690s with status 200
2025-06-08 12:18:16,739 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-08 12:18:16,740 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-08 12:18:16,963 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:18:16,964 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:18:16,965 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:18:16,972 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:18:16,989 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:18:16,989 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:18:17,710 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:18:22,075 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:18:22,081 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 763 символов
2025-06-08 12:18:22,088 - api - INFO - Response: POST /chat completed in 5.124s with status 200
2025-06-08 12:18:26,637 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:18:26,638 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:18:26,640 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:18:26,640 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-08 12:18:26,648 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:18:26,677 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:18:26,677 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:18:27,594 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:18:32,081 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:18:32,086 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 717 символов
2025-06-08 12:18:32,086 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-08 12:18:32,091 - api - INFO - Response: POST /chat completed in 5.454s with status 200
2025-06-08 12:26:28,896 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-08 12:26:28,905 - api - INFO - Response: GET /health completed in 0.008s with status 200
2025-06-08 12:26:28,910 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:26:28,911 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:26:28,913 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:26:28,923 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:26:28,944 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:26:28,944 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:26:30,150 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:26:32,163 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:26:32,166 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 231 символов
2025-06-08 12:26:32,170 - api - INFO - Response: POST /chat completed in 3.260s with status 200
2025-06-08 12:26:35,708 - main - INFO - Завершение работы приложения
2025-06-08 12:26:35,708 - main - INFO - Кэш очищен
2025-06-08 12:26:38,642 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-08 12:26:38,669 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-08 12:26:38,669 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-08 12:26:38,669 - main - INFO - Кэш-сервис инициализирован
2025-06-08 12:26:38,669 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-08 12:26:38,669 - main - INFO - Приложение успешно запущено
2025-06-08 12:27:07,826 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-08 12:27:07,828 - api - INFO - Response: GET /health completed in 0.002s with status 200
2025-06-08 12:27:07,832 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:27:07,832 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:27:07,835 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:27:07,862 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:27:07,976 - faiss.loader - INFO - Loading faiss.
2025-06-08 12:27:08,001 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-08 12:27:08,005 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-08 12:27:08,012 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:27:08,012 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:27:49,498 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:27:52,697 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:27:52,713 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 273 символов
2025-06-08 12:27:52,721 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:27:52,723 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:27:52,723 - api - INFO - Response: POST /chat completed in 44.892s with status 200
2025-06-08 12:27:52,726 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:27:52,726 - main - WARNING - Ошибка при получении из кэша: Object of type datetime is not JSON serializable
2025-06-08 12:27:52,742 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:27:52,773 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:27:52,773 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:27:54,025 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:27:57,690 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:27:57,696 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 704 символов
2025-06-08 12:27:57,697 - main - WARNING - Ошибка при сохранении в кэш: Object of type datetime is not JSON serializable
2025-06-08 12:27:57,700 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-08 12:27:57,702 - api - INFO - Response: POST /chat completed in 4.981s with status 200
2025-06-08 12:27:57,704 - api - INFO - Response: GET /health completed in 0.004s with status 200
2025-06-08 12:27:57,741 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 12:27:57,742 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 12:27:57,743 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 12:27:57,754 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 12:27:57,780 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 12:27:57,780 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 12:27:58,483 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 12:28:02,642 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 12:28:02,647 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 677 символов
2025-06-08 12:28:02,652 - api - INFO - Response: POST /chat completed in 4.911s with status 200
2025-06-08 12:28:11,042 - main - INFO - Завершение работы приложения
2025-06-08 12:28:11,043 - main - INFO - Кэш очищен
2025-06-08 19:00:45,415 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-08 19:00:45,461 - src.middleware.auth - INFO - API Key аутентификация: включена
2025-06-08 19:00:45,462 - main - INFO - Запуск приложения OptimaAI Bot
2025-06-08 19:00:45,462 - main - INFO - Кэш-сервис инициализирован
2025-06-08 19:00:45,462 - src.security.config_validator - INFO - ✅ Оценка безопасности: 90/100 (ОТЛИЧНО). Предупреждений: 2.
2025-06-08 19:00:45,462 - main - INFO - Приложение успешно запущено
2025-06-08 19:01:14,442 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-08 19:01:14,444 - api - INFO - Response: GET /health completed in 0.002s with status 200
2025-06-08 19:01:14,448 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 19:01:14,448 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 19:01:14,450 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 19:01:14,488 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 19:01:14,616 - src.services.rag_service - INFO - Локальное окружение - force_reload: False
2025-06-08 19:01:14,618 - faiss.loader - INFO - Loading faiss.
2025-06-08 19:01:14,653 - faiss.loader - INFO - Successfully loaded faiss.
2025-06-08 19:01:14,657 - faiss - INFO - Failed to load GPU Faiss: name 'GpuIndexIVFFlat' is not defined. Will not load constructor refs for GPU indexes. This is only an error if you're trying to use GPU Faiss.
2025-06-08 19:01:14,664 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 19:01:14,664 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 19:01:16,549 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 19:01:19,612 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 19:01:19,623 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 266 символов
2025-06-08 19:01:19,628 - api - INFO - Response: POST /chat completed in 5.180s with status 200
2025-06-08 19:01:21,073 - api - INFO - Request: GET /health from 127.0.0.1
2025-06-08 19:01:21,075 - api - INFO - Response: GET /health completed in 0.001s with status 200
2025-06-08 19:01:21,210 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 19:01:21,210 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 19:01:21,211 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 19:01:21,221 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 19:01:21,236 - src.services.rag_service - INFO - Локальное окружение - force_reload: False
2025-06-08 19:01:21,243 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 19:01:21,243 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 19:01:21,956 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 19:01:27,311 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 19:01:27,313 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 642 символов
2025-06-08 19:01:27,315 - api - INFO - Response: POST /chat completed in 6.106s with status 200
2025-06-08 19:02:12,493 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 19:02:12,497 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 19:02:12,503 - main - INFO - История сообщений обрезана: 1 сообщений
2025-06-08 19:02:12,516 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 19:02:12,531 - src.services.rag_service - INFO - Локальное окружение - force_reload: False
2025-06-08 19:02:12,544 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 19:02:12,544 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 19:02:13,261 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 19:02:19,995 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 19:02:19,999 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 782 символов
2025-06-08 19:02:20,004 - api - INFO - Response: POST /chat completed in 7.512s with status 200
2025-06-08 19:05:29,035 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 19:05:29,038 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 19:05:29,042 - main - INFO - История сообщений обрезана: 3 сообщений
2025-06-08 19:05:29,057 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 19:05:29,073 - src.services.rag_service - INFO - Локальное окружение - force_reload: False
2025-06-08 19:05:29,083 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 19:05:29,083 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 19:05:30,296 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 19:05:35,039 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 19:05:35,044 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 698 символов
2025-06-08 19:05:35,051 - api - INFO - Response: POST /chat completed in 6.017s with status 200
2025-06-08 19:05:59,386 - api - INFO - Request: POST /chat from 127.0.0.1
2025-06-08 19:05:59,388 - src.middleware.auth - INFO - Успешная аутентификация для /chat
2025-06-08 19:05:59,389 - main - INFO - История сообщений обрезана: 5 сообщений
2025-06-08 19:05:59,403 - src.services.rag_service - INFO - Инициализация RAG системы. Данные: /Users/maximpenkin/Documents/openai/site/backend/rag, Индекс: /Users/maximpenkin/Documents/openai/site/backend/rag_index
2025-06-08 19:05:59,429 - src.services.rag_service - INFO - Локальное окружение - force_reload: False
2025-06-08 19:05:59,437 - src.services.rag_service - INFO - RAG система успешно инициализирована
2025-06-08 19:05:59,437 - src.services.openai_service - INFO - RAG сервис успешно инициализирован
2025-06-08 19:06:00,023 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/embeddings "HTTP/1.1 200 OK"
2025-06-08 19:06:02,185 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-06-08 19:06:02,190 - src.services.openai_service - INFO - Сгенерирован ответ с использованием RAG системы: 207 символов
2025-06-08 19:06:02,201 - api - INFO - Response: POST /chat completed in 2.815s with status 200
