name: Performance Monitoring

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð² 2:00 UTC
    - cron: '0 2 * * *'

jobs:
  performance-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install locust pytest-benchmark
    
    - name: Run benchmark tests
      run: |
        pytest tests/ -k benchmark --benchmark-json=benchmark-results.json
    
    - name: Run load tests with Locust
      run: |
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð² Ñ„Ð¾Ð½Ðµ
        python main.py &
        APP_PID=$!
        
        # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
        sleep 10
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð½Ð°Ð³Ñ€ÑƒÐ·Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
        locust -f tests/load_tests.py --headless -u 10 -r 2 -t 30s --host=http://localhost:8000 --html=load-test-report.html
        
        # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
        kill $APP_PID
    
    - name: Memory profiling
      run: |
        python -m memory_profiler tests/test_memory_usage.py > memory-profile.txt
    
    - name: Generate performance report
      run: |
        echo "# Performance Report" > performance-report.md
        echo "" >> performance-report.md
        echo "## Benchmark Results" >> performance-report.md
        echo "" >> performance-report.md
        
        if [ -f benchmark-results.json ]; then
          python -c "
import json
with open('benchmark-results.json', 'r') as f:
    data = json.load(f)
    
for benchmark in data['benchmarks']:
    print(f\"- **{benchmark['name']}**: {benchmark['stats']['mean']:.4f}s (Â±{benchmark['stats']['stddev']:.4f}s)\")
" >> performance-report.md
        fi
        
        echo "" >> performance-report.md
        echo "## Memory Usage" >> performance-report.md
        echo "" >> performance-report.md
        echo "\`\`\`" >> performance-report.md
        cat memory-profile.txt >> performance-report.md
        echo "\`\`\`" >> performance-report.md
    
    - name: Upload performance artifacts
      uses: actions/upload-artifact@v3
      with:
        name: performance-reports-${{ github.sha }}
        path: |
          benchmark-results.json
          load-test-report.html
          memory-profile.txt
          performance-report.md
    
    - name: Comment PR with performance results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = fs.readFileSync('performance-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸš€ Performance Test Results\n\n${report}`
            });
          } catch (error) {
            console.log('Could not read performance report:', error);
          }

  docker-performance:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t optimaai-bot:test .
    
    - name: Test Docker image performance
      run: |
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
        docker run -d --name perf-test -p 8000:8000 optimaai-bot:test
        
        # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
        sleep 30
        
        # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ
        echo "Testing container startup time and resource usage..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
        docker stats --no-stream perf-test > docker-stats.txt
        
        # ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ‚ÐµÑÑ‚ Ð¾Ñ‚ÐºÐ»Ð¸ÐºÐ°
        time curl -f http://localhost:8000/health
        
        # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€
        docker stop perf-test
        docker rm perf-test
    
    - name: Analyze Docker image size
      run: |
        echo "# Docker Image Analysis" > docker-analysis.md
        echo "" >> docker-analysis.md
        echo "## Image Size" >> docker-analysis.md
        docker images optimaai-bot:test --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" >> docker-analysis.md
        echo "" >> docker-analysis.md
        echo "## Layer Analysis" >> docker-analysis.md
        docker history optimaai-bot:test --format "table {{.CreatedBy}}\t{{.Size}}" >> docker-analysis.md
    
    - name: Upload Docker performance artifacts
      uses: actions/upload-artifact@v3
      with:
        name: docker-performance-${{ github.sha }}
        path: |
          docker-stats.txt
          docker-analysis.md